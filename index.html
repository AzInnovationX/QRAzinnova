<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRAzInnova - Generador de CÃ³digos QR</title>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6856556862133155"
     crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        /* 1. Design System: Variables */
        :root {
            /* Color Palette */
            --primary-color: #3b82f6;
            --primary-color-hover: #2563eb;
            --secondary-color: #10b981;
            --secondary-color-hover: #059669;
            --text-color: #1f2937;
            --text-color-secondary: #6b7280;
            --bg-color: #f9fafb;
            --surface-color: #ffffff;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg-color: #ffffff;

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-sm: 0.875rem; /* 14px */
            --font-size-base: 1rem; /* 16px */
            --font-size-lg: 1.125rem; /* 18px */
            --font-size-xl: 1.25rem; /* 20px */
            --font-size-2xl: 1.5rem; /* 24px */
            --font-size-3xl: 2.25rem; /* 36px */

            /* Spacing */
            --space-1: 0.25rem; /* 4px */
            --space-2: 0.5rem;  /* 8px */
            --space-3: 0.75rem; /* 12px */
            --space-4: 1rem;    /* 16px */
            --space-5: 1.25rem; /* 20px */
            --space-6: 1.5rem;  /* 24px */
            --space-8: 2rem;    /* 32px */
            --space-10: 2.5rem; /* 40px */

            /* Border Radius */
            --radius-sm: 0.25rem; /* 4px */
            --radius-md: 0.5rem;  /* 8px */
            --radius-lg: 0.75rem; /* 12px */
            --radius-xl: 1rem;    /* 16px */
            --radius-2xl: 1.5rem; /* 24px */
            
            /* Transitions */
            --transition-fast: all 0.2s ease-in-out;
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-color-hover: #60a5fa;
            --secondary-color: #10b981;
            --secondary-color-hover: #34d399;
            --text-color: #f9fafb;
            --text-color-secondary: #9ca3af;
            --bg-color: #111827;
            --surface-color: #1f2937;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg-color: #374151;
        }


        /* 2. Base & Reset Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            color-scheme: light;
        }

        html[data-theme="dark"] {
            color-scheme: dark;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-5);
        }

        /* 3. Header & Theme Switcher */
        .header {
            text-align: center;
            margin-bottom: var(--space-10);
            color: var(--text-color);
        }

        .header h1 {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            margin-bottom: var(--space-2);
            text-shadow: 0 2px 4px var(--shadow-color);
        }

        .header p {
            font-size: var(--font-size-lg);
            color: var(--text-color-secondary);
        }

        .theme-switcher {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }

        .theme-label {
            font-size: var(--font-size-xl);
            cursor: pointer;
            line-height: 1;
        }

        .theme-toggle {
            appearance: none;
            width: 3rem;
            height: 1.5rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            background-color: var(--primary-color);
            border-radius: 50%;
            top: 1px;
            left: 1px;
            transition: var(--transition-fast);
        }

        .theme-toggle:checked::before {
            transform: translateX(1.5rem);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }


        /* 4. Main Card & Tabs */
        .main-card {
            background: var(--surface-color);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: var(--transition-fast);
        }

        .tabs {
            display: flex;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            padding: var(--space-2);
            margin-bottom: var(--space-8);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: var(--primary-color) transparent;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 4px;
        }

        .tab {
            flex: 1;
            padding: var(--space-3) var(--space-5);
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            color: var(--text-color-secondary);
            transition: var(--transition-fast);
            white-space: nowrap;
            min-width: 120px;
            text-align: center;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .tab:hover:not(.active) {
            background: var(--border-color);
            color: var(--text-color);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }


        /* 5. Forms & Inputs */
        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            transition: var(--transition-fast);
            background: var(--input-bg-color);
            color: var(--text-color);
            appearance: none;
            min-height: 48px; /* Touch target size */
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-5);
        }

        .color-input {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .color-picker {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-color);
        }


        /* 6. Buttons */
        .generate-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            width: 100%;
            margin: var(--space-5) 0;
            min-height: 48px; /* Touch target size */
        }

        .generate-btn:hover {
            background: var(--primary-color-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .download-buttons {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            flex-wrap: wrap;
        }

        .download-btn {
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            min-height: 44px; /* Touch target size */
        }

        .download-btn.primary {
            background: var(--secondary-color);
            color: white;
        }
        .download-btn.primary:hover {
            background: var(--secondary-color-hover);
        }

        .download-btn.secondary {
            background: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .download-btn.secondary:hover {
            background: var(--bg-color);
            border-color: var(--text-color-secondary);
        }


        /* 7. Result & History */
        .result-section {
            display: none;
            margin-top: var(--space-10);
            padding: var(--space-8);
            background: var(--bg-color);
            border-radius: var(--radius-xl);
            text-align: center;
        }

        .result-section.show { display: block; }

        .qr-preview {
            display: inline-block;
            padding: var(--space-4);
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: 0 8px 24px var(--shadow-color);
            margin-bottom: var(--space-6);
        }

        .qr-preview canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .history {
            margin-top: var(--space-10);
            padding: var(--space-8);
            background: var(--bg-color);
            border-radius: var(--radius-xl);
        }

        .history h3 {
            margin-bottom: var(--space-5);
            color: var(--text-color);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--surface-color);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: var(--transition-fast);
        }

        .history-item:hover {
            box-shadow: 0 4px 8px var(--shadow-color);
            transform: translateY(-1px);
        }

        .history-content {
            font-weight: 500;
            color: var(--text-color);
            word-break: break-word;
        }

        .history-type {
            background: var(--primary-color);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            flex-shrink: 0;
        }


        /* 8. Responsive Design */
        @media (max-width: 768px) {
            .container { padding: var(--space-4); }
            .main-card { padding: var(--space-5); }
            .header { margin-bottom: var(--space-8); }
            .header h1 { font-size: var(--font-size-2xl); }
            .header p { font-size: var(--font-size-base); }
            .form-row { grid-template-columns: 1fr; }
            .download-buttons { flex-direction: column; width: 100%; }
            .history-item { flex-direction: column; align-items: flex-start; gap: var(--space-2); }
            .history-type { align-self: flex-end; }
            .result-section, .history { padding: var(--space-5); }
        }

        @media (max-width: 480px) {
            body {
                -webkit-text-size-adjust: 100%; /* Prevent iOS font scaling */
            }
            .container { padding: var(--space-2); }
            .main-card { padding: var(--space-4); border-radius: var(--radius-xl); }
            .header { margin-bottom: var(--space-6); }
            .header h1 { font-size: var(--font-size-xl); }
            .tab { padding: var(--space-3) var(--space-4); font-size: var(--font-size-sm); min-width: 90px; }
            .generate-btn { font-size: var(--font-size-base); }
            .qr-preview { padding: var(--space-3); }
        }

        /* 9. Validation & Feedback */
        .form-control.is-invalid {
            border-color: #ef4444;
        }
        .form-control.is-valid {
            border-color: var(--secondary-color);
        }

        #toast-container {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            width: calc(100% - 2 * var(--space-4));
            max-width: 350px;
        }

        .toast {
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px var(--shadow-color);
            opacity: 0;
            transform: translateY(100%);
            animation: slideInUp 0.5s forwards, fadeOut 0.5s 3.5s forwards;
        }

        .toast.success { background-color: var(--secondary-color); }
        .toast.error { background-color: #ef4444; }
        [data-theme="dark"] .toast.error { background-color: #f87171; color: var(--bg-color); }

        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ð¯ QRAzInnova</h1>
            <p>Generador profesional de cÃ³digos QR con personalizaciÃ³n avanzada</p>
            <div class="theme-switcher">
                <label for="theme-toggle" class="theme-label">
                    <span class="sr-only">Cambiar tema</span>
                    âï¸
                </label>
                <input type="checkbox" id="theme-toggle" class="theme-toggle">
                <label for="theme-toggle" class="theme-label">
                    <span class="sr-only">Cambiar tema</span>
                    ð
                </label>
            </div>
        </div>

        <div class="main-card">
            <div class="tabs">
                <button class="tab active" data-tab="text">ð Texto</button>
                <button class="tab" data-tab="url">ð URL</button>
                <button class="tab" data-tab="wifi">ð¶ WiFi</button>
                <button class="tab" data-tab="email">ð§ Email</button>
                <button class="tab" data-tab="sms">ð¬ SMS</button>
                <button class="tab" data-tab="contact">ð¤ Contacto</button>
            </div>

            <!-- Tab Content: Texto -->
            <div id="text-tab" class="tab-content active">
                <div class="form-group">
                    <label for="text-input">Texto a codificar:</label>
                    <textarea id="text-input" class="form-control" placeholder="Ingresa tu texto aquÃ­..." rows="4"></textarea>
                </div>
            </div>

            <!-- Tab Content: URL -->
            <div id="url-tab" class="tab-content">
                <div class="form-group">
                    <label for="url-input">URL:</label>
                    <input type="url" id="url-input" class="form-control" placeholder="https://ejemplo.com">
                </div>
            </div>

            <!-- Tab Content: WiFi -->
            <div id="wifi-tab" class="tab-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="wifi-ssid">Nombre de la red (SSID):</label>
                        <input type="text" id="wifi-ssid" class="form-control" placeholder="Mi_WiFi">
                    </div>
                    <div class="form-group">
                        <label for="wifi-password">ContraseÃ±a:</label>
                        <input type="password" id="wifi-password" class="form-control" placeholder="ContraseÃ±a">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="wifi-security">Tipo de seguridad:</label>
                        <select id="wifi-security" class="form-control">
                            <option value="WPA">WPA/WPA2</option>
                            <option value="WEP">WEP</option>
                            <option value="nopass">Sin contraseÃ±a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="wifi-hidden"> Red oculta
                        </label>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Email -->
            <div id="email-tab" class="tab-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="email-to">Email:</label>
                        <input type="email" id="email-to" class="form-control" placeholder="ejemplo@correo.com">
                    </div>
                    <div class="form-group">
                        <label for="email-subject">Asunto:</label>
                        <input type="text" id="email-subject" class="form-control" placeholder="Asunto del email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="email-body">Mensaje:</label>
                    <textarea id="email-body" class="form-control" placeholder="Mensaje del email..." rows="3"></textarea>
                </div>
            </div>

            <!-- Tab Content: SMS -->
            <div id="sms-tab" class="tab-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="sms-number">NÃºmero de telÃ©fono:</label>
                        <input type="tel" id="sms-number" class="form-control" placeholder="+52 55 1234 5678">
                    </div>
                </div>
                <div class="form-group">
                    <label for="sms-message">Mensaje:</label>
                    <textarea id="sms-message" class="form-control" placeholder="Mensaje de texto..." rows="3"></textarea>
                </div>
            </div>

            <!-- Tab Content: Contacto -->
            <div id="contact-tab" class="tab-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact-name">Nombre:</label>
                        <input type="text" id="contact-name" class="form-control" placeholder="Nombre completo">
                    </div>
                    <div class="form-group">
                        <label for="contact-phone">TelÃ©fono:</label>
                        <input type="tel" id="contact-phone" class="form-control" placeholder="+52 55 1234 5678">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact-email">Email:</label>
                        <input type="email" id="contact-email" class="form-control" placeholder="email@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="contact-org">OrganizaciÃ³n:</label>
                        <input type="text" id="contact-org" class="form-control" placeholder="Empresa">
                    </div>
                </div>
                <div class="form-group">
                    <label for="contact-address">DirecciÃ³n:</label>
                    <textarea id="contact-address" class="form-control" placeholder="DirecciÃ³n completa..." rows="2"></textarea>
                </div>
            </div>

            <!-- ConfiguraciÃ³n avanzada -->
            <div style="border-top: 1px solid var(--border-color); padding-top: var(--space-8); margin-top: var(--space-8);">
                <h3 style="margin-bottom: var(--space-5); color: var(--text-color);">âï¸ PersonalizaciÃ³n</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>TamaÃ±o del QR:</label>
                        <div class="size-selector">
                            <div class="size-option active" data-size="256">256px</div>
                            <div class="size-option" data-size="512">512px</div>
                            <div class="size-option" data-size="1024">1024px</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="error-level">Nivel de correcciÃ³n de errores:</label>
                        <select id="error-level" class="form-control">
                            <option value="L">Bajo (7%)</option>
                            <option value="M" selected>Medio (15%)</option>
                            <option value="Q">Alto (25%)</option>
                            <option value="H">Muy Alto (30%)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fg-color">Color del cÃ³digo:</label>
                        <div class="color-input">
                            <input type="color" id="fg-color" class="color-picker" value="#000000">
                            <span>#000000</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bg-color">Color de fondo:</label>
                        <div class="color-input">
                            <input type="color" id="bg-color" class="color-picker" value="#ffffff">
                            <span>#ffffff</span>
                        </div>
                    </div>
                </div>
            </div>

            <button id="generate-btn" class="generate-btn">
                ð¯ Generar con QRAzInnova
            </button>

            <div id="result" class="result-section">
                <div id="qr-container" class="qr-preview"></div>
                <div class="download-buttons">
                    <button id="download-png-btn" class="download-btn primary">
                        ð¥ Descargar PNG
                    </button>
                    <button id="download-svg-btn" class="download-btn secondary">
                        ð¥ Descargar SVG
                    </button>
                    <button id="copy-btn" class="download-btn secondary">
                        ð Copiar imagen
                    </button>
                </div>
            </div>

            <div class="history">
                <h3>ð Historial reciente</h3>
                <div id="history-list">
                    <p style="text-align: center; color: var(--text-color-secondary); font-style: italic;">No hay cÃ³digos QR generados aÃºn</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script>
        // Global variables
        let currentQR = null;
        let currentSize = 256;
        let qrHistory = [];
        let qrInstance = null; // To store the QR object instance for reuse

        /**
         * Initializes the application by loading history and setting up event listeners.
         */
        function initialize() {
            loadAndApplyTheme();
            loadHistory();
            updateHistoryDisplay();
            setupEventListeners();
            // Set initial color values in text spans
            document.getElementById('fg-color').dispatchEvent(new Event('input'));
            document.getElementById('bg-color').dispatchEvent(new Event('input'));
        }

        /**
         * Attaches all necessary event listeners to the DOM elements.
         */
        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', handleTabClick);
            });

            document.querySelectorAll('.size-option').forEach(option => {
                option.addEventListener('click', handleSizeClick);
            });

            document.getElementById('generate-btn').addEventListener('click', generateQR);
            document.getElementById('download-png-btn').addEventListener('click', downloadPNG);
            document.getElementById('download-svg-btn').addEventListener('click', downloadSVG);
            document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
            
            document.addEventListener('input', handleFormInput);

            document.getElementById('fg-color').addEventListener('input', handleColorChange);
            document.getElementById('bg-color').addEventListener('input', handleColorChange);
            
            document.getElementById('theme-toggle').addEventListener('change', handleThemeToggle);
        }

        /**
         * Applies the saved theme from localStorage or system preference.
         */
        function loadAndApplyTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').checked = savedTheme === 'dark';
        }

        /**
         * Handles the theme switcher toggle event.
         * @param {Event} event The change event from the theme toggle checkbox.
         */
        function handleThemeToggle(event) {
            const newTheme = event.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        /**
         * Handles tab switching.
         * @param {Event} event The click event from the tab button.
         */
        function handleTabClick(event) {
            const tabName = event.currentTarget.dataset.tab;

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        /**
         * Handles QR code size selection.
         * @param {Event} event The click event from the size option.
         */
        function handleSizeClick(event) {
            currentSize = parseInt(event.currentTarget.dataset.size, 10);
            document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        /**
         * Updates the text span next to a color picker.
         * @param {Event} event The input event from the color picker.
         */
        function handleColorChange(event) {
            event.currentTarget.nextElementSibling.textContent = event.currentTarget.value;
        }

        /**
         * Handles form input for validation and auto-generation.
         * @param {Event} event The input event from a form control.
         */
        function handleFormInput(event) {
            if (event.target.classList.contains('form-control')) {
                validateInput(event.target);

                clearTimeout(window.autoGenerateTimeout);
                window.autoGenerateTimeout = setTimeout(() => {
                    const activeInputs = document.querySelectorAll('.tab-content.active .form-control');
                    const allValid = Array.from(activeInputs).every(input => !input.classList.contains('is-invalid'));
                    const hasContent = Array.from(activeInputs).some(input => {
                        return input.type === 'checkbox' ? true : input.value.trim();
                    });

                    if (hasContent && allValid) {
                        generateQR();
                    }
                }, 800);
            }
        }

        /**
         * Validates an input field and adds corresponding classes.
         * @param {HTMLInputElement} element The input element to validate.
         */
        function validateInput(element) {
            element.classList.remove('is-valid', 'is-invalid');
            if (!element.value.trim()) return; // Don't validate empty fields

            let isValid = true;
            // Only validate fields that need it
            if (element.type === 'url' || element.type === 'email') {
                 switch (element.type) {
                    case 'url':
                        // Simple regex for URL, as new URL() can be too strict for user input
                        isValid = /^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([/\w .-]*)*\/?$/.test(element.value);
                        break;
                    case 'email':
                        isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(element.value);
                        break;
                }
                 element.classList.add(isValid ? 'is-valid' : 'is-invalid');
            }
        }


        /**
         * Gathers data from the active tab and generates the QR code.
         */
        function generateQR() {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            let qrText = '';
            let qrType = '';

            const inputGetters = {
                text: () => ({ text: document.getElementById('text-input').value, type: 'Texto' }),
                url: () => ({ text: document.getElementById('url-input').value, type: 'URL' }),
                wifi: () => {
                    const ssid = document.getElementById('wifi-ssid').value;
                    const password = document.getElementById('wifi-password').value;
                    const security = document.getElementById('wifi-security').value;
                    const hidden = document.getElementById('wifi-hidden').checked;
                    return { text: `WIFI:T:${security};S:${ssid};P:${password};H:${hidden};`, type: 'WiFi' };
                },
                email: () => {
                    const to = document.getElementById('email-to').value;
                    const subject = document.getElementById('email-subject').value;
                    const body = document.getElementById('email-body').value;
                    return { text: `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, type: 'Email' };
                },
                sms: () => {
                    const number = document.getElementById('sms-number').value;
                    const message = document.getElementById('sms-message').value;
                    return { text: `sms:${number}?body=${encodeURIComponent(message)}`, type: 'SMS' };
                },
                contact: () => {
                    const name = document.getElementById('contact-name').value;
                    const phone = document.getElementById('contact-phone').value;
                    const email = document.getElementById('contact-email').value;
                    const org = document.getElementById('contact-org').value;
                    const address = document.getElementById('contact-address').value;
                    return { text: `BEGIN:VCARD
VERSION:3.0
FN:${name}
TEL:${phone}
EMAIL:${email}
ORG:${org}
ADR:${address}
END:VCARD`, type: 'Contacto' };
                }
            };
            
            const data = inputGetters[activeTab]();
            qrText = data.text;
            qrType = data.type;

            if (!qrText.trim()) {
                showToast('Por favor, ingresa el contenido para el cÃ³digo QR.', 'error');
                return;
            }

            const errorLevel = document.getElementById('error-level').value;
            const fgColor = document.getElementById('fg-color').value;
            const bgColor = document.getElementById('bg-color').value;

            try {
                qrInstance = qrcode(0, errorLevel);
                qrInstance.addData(qrText);
                qrInstance.make();

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const moduleCount = qrInstance.getModuleCount();
                const moduleSize = Math.max(1, Math.floor(currentSize / moduleCount));
                const actualSize = moduleSize * moduleCount;
                
                canvas.width = actualSize;
                canvas.height = actualSize;

                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, actualSize, actualSize);

                ctx.fillStyle = fgColor;
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qrInstance.isDark(row, col)) {
                            ctx.fillRect(col * moduleSize, row * moduleSize, moduleSize, moduleSize);
                        }
                    }
                }
                
                currentQR = canvas;
                const container = document.getElementById('qr-container');
                container.innerHTML = '';
                container.appendChild(canvas);
                document.getElementById('result').classList.add('show');
                
                addToHistory(qrText, qrType);

            } catch (error) {
                showToast('Error al generar el cÃ³digo QR: ' + error.message, 'error');
            }
        }

        function addToHistory(content, type) {
            const historyItem = {
                content: content.length > 50 ? content.substring(0, 50) + '...' : content,
                type: type,
                date: new Date().toLocaleString()
            };
            qrHistory.unshift(historyItem);
            if (qrHistory.length > 5) qrHistory.pop();
            saveHistory();
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const list = document.getElementById('history-list');
            if (qrHistory.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-color-secondary); font-style: italic;">No hay cÃ³digos QR generados aÃºn</p>';
                return;
            }
            list.innerHTML = qrHistory.map(item => `
                <div class="history-item">
                    <div>
                        <div class="history-content">${item.content}</div>
                        <small style="color: var(--text-color-secondary);">${item.date}</small>
                    </div>
                    <div class="history-type">${item.type}</div>
                </div>
            `).join('');
        }

        function saveHistory() {
            localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
        }

        function loadHistory() {
            const saved = localStorage.getItem('qrHistory');
            if (saved) {
                qrHistory = JSON.parse(saved);
            }
        }

        function downloadPNG() {
            if (!currentQR) {
                showToast('Primero genera un cÃ³digo QR', 'error');
                return;
            }
            const link = document.createElement('a');
            link.download = `qr-code-${Date.now()}.png`;
            link.href = currentQR.toDataURL('image/png');
            link.click();
        }

        function downloadSVG() {
            if (!qrInstance) {
                showToast('Primero genera un cÃ³digo QR', 'error');
                return;
            }
            const moduleCount = qrInstance.getModuleCount();
            const fgColor = document.getElementById('fg-color').value;
            const bgColor = document.getElementById('bg-color').value;
            const size = currentSize;
            const moduleSize = size / moduleCount;

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
            svg += `<rect width="100%" height="100%" fill="${bgColor}"/>`;
            
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (qrInstance.isDark(row, col)) {
                        svg += `<rect x="${col * moduleSize}" y="${row * moduleSize}" width="${moduleSize}" height="${moduleSize}" fill="${fgColor}"/>`;
                    }
                }
            }
            
            svg += '</svg>';

            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const link = document.createElement('a');
            link.download = `qr-code-${Date.now()}.svg`;
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        async function copyToClipboard() {
            if (!currentQR) {
                showToast('Primero genera un cÃ³digo QR', 'error');
                return;
            }
            try {
                currentQR.toBlob(async (blob) => {
                    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    showToast('Imagen copiada al portapapeles', 'success');
                });
            } catch (error) {
                console.error('Error al copiar la imagen:', error);
                showToast('Error al copiar la imagen: ' + error.message, 'error');
            }
        }

        /**
         * Displays a toast notification.
         * @param {string} message The message to display.
         * @param {'success' | 'error'} type The type of toast.
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
